# 数据库编程
## 数据持久化技术概述
1. 文本文件
2. 数据库

## MySQL数据库管理系统
## Python DB-API
### 建立数据连接
### 创建游标
## 案例：MySQL数据库CURD操作
### 安装PyMySQL模块
### 数据查询操作
#### 有条件查询实现代码


```python
import pymysql

# 1. 建立数据库连接
connection = pymysql.connect(host='localhost',
                             user='root',
                             password='986370165',
                             database='MyDB',
                             charset='utf8')

try:
    # 2. 创建游标对象
    with connection.cursor() as cursor:

        # 3. 执行SQL操作
        # sql = 'select name, userid from user where userid >%s'
        # cursor.execute(sql, [0])
        sql = 'select name, userid from user where userid >%(id)s'
        cursor.execute(sql, {'id': 0})

        # 4. 提取结果集
        result_set = cursor.fetchall()

        for row in result_set:
            print('id：{0} - name：{1}'.format(row[1], row[0]))

    # with代码块结束 5. 关闭游标

finally:
    # 6. 关闭数据连接
    connection.close()
```

    id：1 - name：Tom
    id：2 - name：Ben
    

#### 无条件查询实现代码


```python
import pymysql

# 1. 建立数据库连接
connection = pymysql.connect(host='localhost',
                             user='root',
                             password='986370165',
                             database='MyDB',
                             charset='utf8')

try:
    # 2. 创建游标对象
    with connection.cursor() as cursor:

        # 3. 执行SQL操作
        sql = 'select max(userid) from user'
        cursor.execute(sql)

        # 4. 提取结果集
        row = cursor.fetchone()

        if row is not None:
            print('最大用户Id ：{0}'.format(row[0]))

    # with代码块结束 5. 关闭游标

finally:
    # 6. 关闭数据连接
    connection.close()
```

    最大用户Id ：2
    

### 数据修改操作
1. 数据插入


```python
import pymysql


# 查询最大用户Id
def read_max_userid():
    # 1. 建立数据库连接
    connection = pymysql.connect(host='localhost',
                                 user='root',
                                 password='986370165',
                                 database='MyDB',
                                 charset='utf8')

    try:
        # 2. 创建游标对象
        with connection.cursor() as cursor:

            # 3. 执行SQL操作
            sql = 'select max(userid) from user'
            cursor.execute(sql)

            # 4. 提取结果集
            row = cursor.fetchone()

            if row is not None:
                print('最大用户Id ：{0}'.format(row[0]))
                return row[0]

        # with代码块结束 5. 关闭游标

    finally:
        # 6. 关闭数据连接
        connection.close()


# 1. 建立数据库连接
connection = pymysql.connect(host='localhost',
                             user='root',
                             password='986370165',
                             database='MyDB',
                             charset='utf8')

# 查询最大值
maxid = read_max_userid()

try:
    # 2. 创建游标对象
    with connection.cursor() as cursor:

        # 3. 执行SQL操作
        sql = 'insert into user (userid, name) values (%s,%s)'
        nextid = maxid + 1
        name = 'Tony' + str(nextid)
        affectedcount = cursor.execute(sql, (nextid, name))

        print('影响的数据行数：{0}'.format(affectedcount))
        # 4. 提交数据库事物
        connection.commit()

    # with代码块结束 5. 关闭游标

except pymysql.DatabaseError:
    # 4. 回滚数据库事物
    connection.rollback()
finally:
    # 6. 关闭数据连接
    connection.close()
```

    最大用户Id ：2
    影响的数据行数：1
    

2. 数据更新


```python
import pymysql

# 1. 建立数据库连接
connection = pymysql.connect(host='localhost',
                             user='root',
                             password='986370165',
                             database='MyDB',
                             charset='utf8')

try:
    # 2. 创建游标对象
    with connection.cursor() as cursor:

        # 3. 执行SQL操作
        sql = 'update user set name = %s where userid > %s'
        affectedcount = cursor.execute(sql, ('Tom', 2))

        print('影响的数据行数：{0}'.format(affectedcount))
        # 4. 提交数据库事物
        connection.commit()

    # with代码块结束 5. 关闭游标

except pymysql.DatabaseError as e:
    # 4. 回滚数据库事物
    connection.rollback()
    print(e)
finally:
    # 6. 关闭数据连接
    connection.close()
```

    影响的数据行数：1
    

3. 数据删除


```python
import pymysql


# 查询最大用户Id
def read_max_userid():
    # 1. 建立数据库连接
    connection = pymysql.connect(host='localhost',
                                 user='root',
                                 password='986370165',
                                 database='MyDB',
                                 charset='utf8')

    try:
        # 2. 创建游标对象
        with connection.cursor() as cursor:

            # 3. 执行SQL操作
            sql = 'select max(userid) from user'
            cursor.execute(sql)

            # 4. 提取结果集
            row = cursor.fetchone()

            if row is not None:
                print('最大用户Id ：{0}'.format(row[0]))
                return row[0]

        # with代码块结束 5. 关闭游标

    finally:
        # 6. 关闭数据连接
        connection.close()


# 1. 建立数据库连接
connection = pymysql.connect(host='localhost',
                             user='root',
                             password='986370165',
                             database='MyDB',
                             charset='utf8')

# 查询最大值
maxid = read_max_userid()

try:
    # 2. 创建游标对象
    with connection.cursor() as cursor:

        # 3. 执行SQL操作
        sql = 'delete from user where userid = %s'
        affectedcount = cursor.execute(sql, (maxid))

        print('影响的数据行数：{0}'.format(affectedcount))
        # 4. 提交数据库事物
        connection.commit()

    # with代码块结束 5. 关闭游标

except pymysql.DatabaseError:
    # 4. 回滚数据库事物
    connection.rollback()
finally:
    # 6. 关闭数据连接
    connection.close()
```

    最大用户Id ：3
    影响的数据行数：1
    

## NoSQL数据存储
### dbm数据库的打开和关闭
dbm.open(file,flag='r')

'r','w','c','n'

with dbm.open(file,'c') as db:

    pass


### dbm数据存储



```python
import dbm

with dbm.open('mydb', 'c') as db:
    db['name'] = 'tony'  # 更新数据
    print(db['name'].decode())  # 取出数据

    age = int(db.get('age', b'18').decode())  # 取出数据
    print(age)

    if 'age' in db:  # 判断是否存在age数据
        db['age'] = '20'  # 或者 b'20'

    del db['name']  # 删除name数据
```

    tony
    18
    


```python

```
